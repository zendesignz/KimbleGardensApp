---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Clients | Kimble Gardens">
  <section class="card">
    <h2>Clients</h2>
    <p class="small">Pick a client tab, edit details, then save.</p>
    <div class="scroll-tabs" id="client-tabs"></div>
    <article class="card" style="margin-top:1rem;">
      <div id="client-summary"></div>
      <form id="client-form" class="form-grid" style="margin-top:1rem;">
        <label class="field"><span>Client name</span><input name="name" required /></label>
        <label class="field"><span>Batch prefix / ID</span><input name="id" required /></label>
        <label class="field"><span>Contact</span><input name="contact" /></label>
        <label class="field" style="grid-column:1/-1;"><span>Progress bullets (one per line)</span><textarea name="notes"></textarea></label>
      </form>
      <div class="actions">
        <button id="save-client" class="kg-button" type="button">Save Client</button>
        <button id="new-client" class="kg-button secondary" type="button">Add New Client</button>
      </div>
    </article>
  </section>

  <script>
    const key = 'kg-clients';
    const defaultClients = [
      { id: 'C-001', name: 'Avery Home', contact: 'avery@example.com', notes: ['Needs shade plants near patio', 'Weekly picture updates requested'] },
      { id: 'C-002', name: 'Maple Dental', contact: 'office@mapledental.com', notes: ['Front bed redesign', 'Spring opening scheduled'] },
      { id: 'C-003', name: 'Pine Family', contact: 'pinefamily@example.com', notes: ['Container herbs project', 'Delivery planned in 3 weeks'] }
    ];

    const saved = localStorage.getItem(key);
    const clients = saved ? JSON.parse(saved) : defaultClients;
    if (!saved) localStorage.setItem(key, JSON.stringify(defaultClients));

    const tabsEl = document.querySelector('#client-tabs');
    const summaryEl = document.querySelector('#client-summary');
    const form = document.querySelector('#client-form');
    const saveBtn = document.querySelector('#save-client');
    const newBtn = document.querySelector('#new-client');
    let activeIndex = 0;

    const saveStore = () => localStorage.setItem(key, JSON.stringify(clients));

    const fillForm = () => {
      const client = clients[activeIndex];
      if (!client || !form || !summaryEl) return;
      form.name.value = client.name;
      form.id.value = client.id;
      form.contact.value = client.contact || '';
      form.notes.value = (client.notes || []).join('\n');
      summaryEl.innerHTML = `<h3>${client.name}</h3><span class="pill">${client.id}</span>`;
    };

    const renderTabs = () => {
      if (!tabsEl) return;
      tabsEl.innerHTML = '';
      clients.forEach((client, index) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = client.name;
        if (index === activeIndex) btn.classList.add('active');
        btn.addEventListener('click', () => {
          activeIndex = index;
          renderTabs();
          fillForm();
        });
        tabsEl.appendChild(btn);
      });
    };

    saveBtn?.addEventListener('click', () => {
      const current = clients[activeIndex];
      if (!current || !form) return;
      current.name = form.name.value.trim();
      current.id = form.id.value.trim();
      current.contact = form.contact.value.trim();
      current.notes = form.notes.value.split('\n').map((n) => n.trim()).filter(Boolean);
      saveStore();
      renderTabs();
      fillForm();
      alert('Client saved.');
    });

    newBtn?.addEventListener('click', () => {
      clients.push({ id: `C-00${clients.length + 1}`, name: 'New Client', contact: '', notes: ['Add progress update here'] });
      activeIndex = clients.length - 1;
      saveStore();
      renderTabs();
      fillForm();
    });

    renderTabs();
    fillForm();
  </script>
</BaseLayout>
