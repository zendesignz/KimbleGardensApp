---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Plant Records | Kimble Gardens">
  <section class="card">
    <h2>Plant Records</h2>
    <p class="small">Select a batch, edit details, and save to local storage.</p>
    <div class="scroll-tabs" id="record-tabs"></div>
    <article class="card" style="margin-top:1rem;">
      <form id="record-form" class="form-grid">
        <label class="field"><span>Batch ID</span><input name="batchId" required /></label>
        <label class="field"><span>Planted</span><input name="planted" type="date" /></label>
        <label class="field"><span>Potting stage</span><input name="pottingStage" /></label>
        <label class="field"><span>Watering status</span><input name="wateringStatus" /></label>
        <label class="field"><span>To be delivered</span><input name="toBeDelivered" /></label>
        <label class="field"><span>Photos (comma separated)</span><input name="photos" /></label>
        <label class="field" style="grid-column:1/-1;"><span>Notes</span><textarea name="notes"></textarea></label>
      </form>
      <div class="actions">
        <button id="save-record" class="kg-button" type="button">Save Record</button>
        <button id="new-record" class="kg-button secondary" type="button">Add New Batch</button>
      </div>
    </article>
  </section>

  <script>
    const key = 'kg-plant-records';
    const defaults = [
      { batchId: 'C-001-TOM-01', planted: '2026-02-01', pottingStage: 'Seedling trays', wateringStatus: 'Moist - checked today', toBeDelivered: '2026-03-10', notes: 'Strong germination. No disease signs.', photos: ['seedling-tray-01.jpg'] },
      { batchId: 'C-002-LAV-01', planted: '2026-01-24', pottingStage: '4-inch pots', wateringStatus: 'Water tomorrow morning', toBeDelivered: 'N/A', notes: 'Pruned lightly. Fertilizer added.', photos: ['lavender-potting-01.jpg'] }
    ];

    const saved = localStorage.getItem(key);
    const records = saved ? JSON.parse(saved) : defaults;
    if (!saved) localStorage.setItem(key, JSON.stringify(defaults));

    const tabsEl = document.querySelector('#record-tabs');
    const form = document.querySelector('#record-form');
    const saveBtn = document.querySelector('#save-record');
    const newBtn = document.querySelector('#new-record');
    let activeIndex = 0;

    const persist = () => localStorage.setItem(key, JSON.stringify(records));

    const fillForm = () => {
      const record = records[activeIndex];
      if (!record || !form) return;
      form.batchId.value = record.batchId || '';
      form.planted.value = record.planted || '';
      form.pottingStage.value = record.pottingStage || '';
      form.wateringStatus.value = record.wateringStatus || '';
      form.toBeDelivered.value = record.toBeDelivered || '';
      form.notes.value = record.notes || '';
      form.photos.value = (record.photos || []).join(', ');
    };

    const renderTabs = () => {
      if (!tabsEl) return;
      tabsEl.innerHTML = '';
      records.forEach((record, index) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = record.batchId;
        if (index === activeIndex) btn.classList.add('active');
        btn.onclick = () => {
          activeIndex = index;
          renderTabs();
          fillForm();
        };
        tabsEl.appendChild(btn);
      });
    };

    saveBtn?.addEventListener('click', () => {
      const record = records[activeIndex];
      if (!record || !form) return;
      record.batchId = form.batchId.value.trim();
      record.planted = form.planted.value;
      record.pottingStage = form.pottingStage.value.trim();
      record.wateringStatus = form.wateringStatus.value.trim();
      record.toBeDelivered = form.toBeDelivered.value.trim();
      record.notes = form.notes.value.trim();
      record.photos = form.photos.value.split(',').map((p) => p.trim()).filter(Boolean);
      persist();
      renderTabs();
      alert('Plant record saved.');
    });

    newBtn?.addEventListener('click', () => {
      records.push({ batchId: `NEW-BATCH-${records.length + 1}`, planted: '', pottingStage: '', wateringStatus: '', toBeDelivered: '', notes: '', photos: [] });
      activeIndex = records.length - 1;
      persist();
      renderTabs();
      fillForm();
    });

    renderTabs();
    fillForm();
  </script>
</BaseLayout>
